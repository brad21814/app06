rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get the current user's data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper to check if user is owner or admin of the account
    function isAccountAdmin(accountId) {
      let userData = getUserData();
      return userData.accountId == accountId && (userData.role == 'owner' || userData.role == 'admin');
    }

    // Helper to check if user is member of the account
    function isAccountMember(accountId) {
      let userData = getUserData();
      return userData.accountId == accountId;
    }

    match /users/{userId} {
      // Users can read and write their own profile
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /accounts/{accountId} {
      // Any authenticated user can create an account
      allow create: if request.auth != null;
      
      // Members can read, Admins/Owners can update
      allow read: if request.auth != null && (resource.data.ownerId == request.auth.uid || isAccountMember(accountId));
      allow update: if request.auth != null && (resource.data.ownerId == request.auth.uid || isAccountAdmin(accountId));
    }

    match /teams/{teamId} {
      // Admins of the parent account can create teams
      allow create: if request.auth != null && isAccountAdmin(request.resource.data.accountId);
      
      // Members of the parent account can read teams
      allow read: if request.auth != null && isAccountMember(resource.data.accountId);
      
      // Admins of the parent account can update teams
      allow update: if request.auth != null && isAccountAdmin(resource.data.accountId);
    }

    match /invitations/{inviteId} {
      // Allow authenticated users to read invitations (relies on ID knowledge)
      allow get: if true;
      allow list: if request.auth != null;
      
      // Only admins of the account can create invites
      allow create: if request.auth != null && isAccountAdmin(request.resource.data.accountId);
      
      // Allow updates (e.g. accepting)
      allow update: if request.auth != null;
    }
    match /team_members/{memberId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Adjusted to allow inviting/adding
    }

    match /activity_logs/{logId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    match /schedules/{scheduleId} {
      allow read, write: if request.auth != null;
    }

    match /themes/{themeId} {
      allow read, write: if request.auth != null;
    }

    match /connections/{connectionId} {
      allow read, write: if request.auth != null;
      
      match /transcripts/{transcriptId} {
        allow read, write: if request.auth != null;
      }
    }
    
    match /analytics/{docId} {
       allow read, write: if request.auth != null;
    }

    match /password_reset_tokens/{tokenId} {
       allow read, write: if request.auth != null; // Simplistic for dev
    }
  }
}
